###
# This file is generated.
#
# To edit, makes changes to the file in templates/ulp.py.j2 and run support/ulp_builder.py.
###

import espulp
import memorymap

from pins import ULP_ADC_PINS, ULP_GPIO_PINS

class ULP:
    def __init__(self):
        self.__program = espulp.ULP(espulp.Architecture.RISCV)
        self.alarm = espulp.ULPAlarm(self.__program)
        self.shared_memory = __SharedMemory__()

    def start(self):
        self.__program.halt()
        self.__program.run(
            {{ code }},
            pins=ULP_GPIO_PINS,
            adc_pins=ULP_ADC_PINS
        )

    def resume(self):
        self.shared_memory.paused = False


class __SharedMemory__:
    def __init__(self):
        self.__memory_map = memorymap.AddressRange(start=0x50000000, length=0x2000)

    @property
    def debug(self):
        return self.__memory_map[{{ symbols.debug }}] == 1

    @property
    def paused(self):
        return self.__memory_map[{{ symbols.paused }}] == 1
    @paused.setter
    def paused(self, value):
        self.__memory_map[{{ symbols.paused }}] = 1 if value else 0

    {% for symbol, locations in symbols.sensors.items() %}
    @property
    def {{ symbol }}(self):
        return self.__read_value({{ locations }})
    {% endfor %}

    def __read_value(self, memory_addresses):
        output = 0
        for i, byte_memory_address in enumerate(memory_addresses):
            byte = self.__memory_map[byte_memory_address]
            output |= byte << (i * 8)
        return output
